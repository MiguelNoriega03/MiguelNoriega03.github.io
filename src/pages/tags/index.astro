---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllTags, getPostsByTag, sortItemsByDateDesc } from '../../utils/data-utils';

const posts = (await getCollection('blog')).sort(sortItemsByDateDesc);
const tags = getAllTags(posts).sort((tagA, tagB) => {
    const postCountTagA = getPostsByTag(posts, tagA.id).length;
    const postCountTagB = getPostsByTag(posts, tagB.id).length;
    return postCountTagB - postCountTagA;
});
---

<BaseLayout
    title="Cont√°ctanos"
    description="¬øTe gustar√≠a m√°s informaci√≥n? ¬°Cont√°ctanos!"
    showHeader={false}
>
    <h1 class="mb-4 font-serif text-2xl font-bold sm:mb-8 sm:text-4xl text-center uppercase tracking-wide">¬øTe gustar√≠a m√°s informaci√≥n de nuestras asesor√≠as? ¬°Cont√°ctanos!</h1>
    
    {/* Formulario de Contacto */}
    <section class="my-12 sm:my-16">
        <div class="max-w-2xl mx-auto bg-white dark:bg-zinc-900 rounded-2xl shadow-lg p-8 sm:p-10">
            <form id="contact-form" class="space-y-6">
                {/* Nombre - Obligatorio */}
                <div>
                    <label for="nombre" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Nombre <span class="text-red-600">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="nombre" 
                        name="nombre" 
                        required
                        placeholder="Tu nombre completo"
                        class="w-full px-4 py-3 border border-gray-300 dark:border-zinc-600 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent transition"
                    />
                </div>

                {/* Empresa - Opcional */}
                <div>
                    <label for="empresa" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Empresa
                    </label>
                    <input 
                        type="text" 
                        id="empresa" 
                        name="empresa"
                        placeholder="Nombre de tu empresa (opcional)"
                        class="w-full px-4 py-3 border border-gray-300 dark:border-zinc-600 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent transition"
                    />
                </div>

                {/* Correo electr√≥nico - Obligatorio */}
                <div>
                    <label for="correo" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Correo electr√≥nico <span class="text-red-600">*</span>
                    </label>
                    <input 
                        type="email" 
                        id="correo" 
                        name="correo" 
                        required
                        placeholder="ejemplo@correo.com"
                        class="w-full px-4 py-3 border border-gray-300 dark:border-zinc-600 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent transition"
                    />
                </div>

                {/* Celular - Oculto por defecto, se muestra y es obligatorio en TikTok */}
                <div id="celular-field" class="hidden">
                    <label for="celular" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Celular (WhatsApp) <span class="text-red-600">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-500 text-sm">üá≤üáΩ +52</span>
                        <input 
                            type="tel" 
                            id="celular" 
                            name="celular"
                            placeholder="55 1234 5678"
                            pattern="[0-9\s\-]{7,15}"
                            class="w-full pl-20 pr-4 py-3 border border-gray-300 dark:border-zinc-600 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent transition"
                        />
                    </div>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Te escribiremos por WhatsApp a este n√∫mero</p>
                </div>

                {/* Soluci√≥n de inter√©s - Obligatorio */}
                <div>
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Soluci√≥n de inter√©s <span class="text-red-600">*</span>
                    </label>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input 
                                type="radio" 
                                name="solucion" 
                                value="Soluciones con IA" 
                                required
                                class="w-5 h-5 text-red-600 border-gray-300 focus:ring-red-500"
                            />
                            <span class="text-gray-700 dark:text-gray-300">Soluciones con IA</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input 
                                type="radio" 
                                name="solucion" 
                                value="Soluciones de venta"
                                class="w-5 h-5 text-red-600 border-gray-300 focus:ring-red-500"
                            />
                            <span class="text-gray-700 dark:text-gray-300">Soluciones de venta</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input 
                                type="radio" 
                                name="solucion" 
                                value="Ambas"
                                class="w-5 h-5 text-red-600 border-gray-300 focus:ring-red-500"
                            />
                            <span class="text-gray-700 dark:text-gray-300">Ambas</span>
                        </label>
                    </div>
                </div>

                {/* Cu√©ntanos m√°s - Opcional */}
                <div>
                    <label for="mas" class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
                        Cu√©ntanos m√°s
                    </label>
                    <textarea 
                        id="mas" 
                        name="mas"
                        rows="4"
                        placeholder="Cualquier informaci√≥n adicional que quieras compartir..."
                        class="w-full px-4 py-3 border border-gray-300 dark:border-zinc-600 rounded-lg bg-white dark:bg-zinc-800 text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-red-500 focus:border-transparent transition resize-y"
                    ></textarea>
                </div>

                {/* Bot√≥n Enviar */}
                <button 
                    type="submit"
                    id="submit-btn"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:shadow-lg transition-all text-lg"
                >
                    Enviar por WhatsApp
                </button>

            </form>
            <p id="whatsapp-hint" class="text-center text-sm text-gray-500 dark:text-gray-400 mt-4">
                Al hacer clic, se abrir√° WhatsApp con tu mensaje listo para enviar.
            </p>

            {/* Mensaje de √©xito para TikTok ‚Äî se muestra tras enviar, FUERA del form */}
            <div id="tiktok-success" class="hidden">
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 dark:bg-green-900/30 rounded-full mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                    <h3 class="text-xl font-serif font-bold text-green-700 dark:text-green-400 mb-2">¬°Formulario enviado exitosamente!</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Nuestro equipo se contactar√° contigo.</p>
                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-3">Normalmente respondemos en menos de 24 horas.</p>
                </div>
            </div>

            {/* Banner de in-app browser - oculto por defecto */}
            <div id="inapp-banner" class="hidden mt-6 p-4 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-xl text-center">
                <p class="text-sm font-semibold text-amber-800 dark:text-amber-300 mb-2">
                    ‚ö†Ô∏è Est√°s usando un navegador interno (TikTok, Instagram, etc.)
                </p>
                <p class="text-xs text-amber-700 dark:text-amber-400 mb-3">
                    Para que WhatsApp abra correctamente, abre esta p√°gina en Safari o Chrome.
                </p>
                <button 
                    id="copy-url-btn"
                    class="inline-flex items-center gap-2 bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-amber-700 transition-colors"
                >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                    Copiar enlace de esta p√°gina
                </button>
            </div>

            {/* Modal de fallback cuando WhatsApp no abre */}
            <div id="fallback-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60">
                <div class="bg-white dark:bg-zinc-900 rounded-2xl shadow-2xl max-w-md w-full p-6 sm:p-8 relative">
                    <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                    
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-14 h-14 bg-green-100 dark:bg-green-900/30 rounded-full mb-4">
                            <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        </div>
                        <h3 class="font-serif text-xl font-semibold mb-2">¬øNo se abri√≥ WhatsApp?</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            Tu navegador bloque√≥ la apertura. Usa una de estas opciones:
                        </p>
                    </div>

                    <div class="space-y-3">
                        {/* Opci√≥n 1: Copiar mensaje y abrir WhatsApp manualmente */}
                        <button id="copy-msg-btn" class="w-full flex items-center gap-3 bg-gray-100 dark:bg-zinc-800 hover:bg-gray-200 dark:hover:bg-zinc-700 text-left px-4 py-3 rounded-xl transition-colors">
                            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                            </div>
                            <div>
                                <p class="font-semibold text-sm text-gray-900 dark:text-white">Copiar mensaje</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Copia el texto y p√©galo en WhatsApp al +52 55 9165 9829</p>
                            </div>
                        </button>

                        {/* Opci√≥n 2: Abrir directo en WhatsApp con intent */}
                        <a id="whatsapp-direct-link" href="#" target="_blank" rel="noopener noreferrer" class="w-full flex items-center gap-3 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl transition-colors">
                            <div class="w-10 h-10 bg-green-700 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            </div>
                            <div>
                                <p class="font-semibold text-sm">Abrir en WhatsApp</p>
                                <p class="text-xs text-green-100">Intentar abrir directamente</p>
                            </div>
                        </a>
                    </div>

                    <div id="copy-success" class="hidden mt-4 p-3 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 rounded-lg text-center">
                        <p class="text-sm font-semibold text-green-700 dark:text-green-400">‚úÖ Mensaje copiado. Env√≠alo al +52 55 9165 9829</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</BaseLayout>

<script>
    const PHONE = '525591659829';

    // --- Detecci√≥n de entorno ---
    function isInAppBrowser(): boolean {
        const ua = navigator.userAgent || navigator.vendor || '';
        return /musical_ly|tiktok|bytedance|instagram|FBAN|FBAV|FB_IAB|snapchat|line\//i.test(ua) 
            || /twitter|wv\)|WebView/i.test(ua);
    }
    function isTikTok(): boolean {
        const ua = navigator.userAgent || navigator.vendor || '';
        return /musical_ly|tiktok|bytedance/i.test(ua);
    }
    function isIOS(): boolean { return /iPhone|iPad|iPod/i.test(navigator.userAgent); }
    function isAndroid(): boolean { return /Android/i.test(navigator.userAgent); }

    // --- Copiar al clipboard con fallback ---
    function copyToClipboard(text: string): Promise<void> {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
        }
        return new Promise((resolve) => {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.cssText = 'position:fixed;opacity:0;left:-9999px;';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            resolve();
        });
    }

    // --- Construir URLs ---
    function buildWhatsAppURLs(message: string) {
        const encoded = encodeURIComponent(message);
        return {
            native: `whatsapp://send?phone=${PHONE}&text=${encoded}`,
            api: `https://api.whatsapp.com/send?phone=${PHONE}&text=${encoded}`,
            intent: `intent://send?phone=${PHONE}&text=${encoded}#Intent;scheme=whatsapp;package=com.whatsapp;end;`,
            wa_me: `https://wa.me/${PHONE}?text=${encoded}`,
        };
    }

    // --- Para Instagram y otros (NO TikTok): auto-redirect con cadena de fallback ---
    function openWhatsAppInApp(message: string, urls: ReturnType<typeof buildWhatsAppURLs>) {
        if (isAndroid()) {
            window.location.href = urls.intent;
            setTimeout(() => {
                window.location.href = urls.native;
                setTimeout(() => {
                    window.location.href = urls.api;
                    setTimeout(() => showFallbackModal(message, urls), 2000);
                }, 1500);
            }, 1500);
        } else if (isIOS()) {
            window.location.href = urls.native;
            setTimeout(() => {
                window.location.href = urls.api;
                setTimeout(() => showFallbackModal(message, urls), 2000);
            }, 1500);
        } else {
            window.location.href = urls.api;
            setTimeout(() => showFallbackModal(message, urls), 3000);
        }
    }

    // --- Para TikTok: mostrar mensaje de √©xito (ya tenemos su celular) ---
    function showTikTokSuccess() {
        try {
            // Ocultar todo: formulario, texto de WhatsApp, banner de TikTok
            const form = document.getElementById('contact-form');
            const hint = document.getElementById('whatsapp-hint');
            const banner = document.getElementById('inapp-banner');
            if (form) form.style.display = 'none'; // style.display es m√°s confiable que classList en WebViews
            if (hint) hint.style.display = 'none';
            if (banner) banner.style.display = 'none';

            // Mostrar mensaje de √©xito
            const success = document.getElementById('tiktok-success');
            if (success) {
                success.classList.remove('hidden');
                success.style.display = 'block';
                // scrollIntoView con behavior:'smooth' falla en algunos WebViews
                // Usar requestAnimationFrame + window.scrollTo para m√°xima compatibilidad
                requestAnimationFrame(() => {
                    try {
                        const rect = success.getBoundingClientRect();
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const targetY = scrollTop + rect.top - (window.innerHeight / 2) + (rect.height / 2);
                        window.scrollTo(0, Math.max(0, targetY));
                    } catch (_) {
                        // Si falla el scroll, al menos el mensaje ya es visible
                    }
                });
            }
        } catch (err) {
            // Safety net: si algo falla, al menos intentar mostrar el √©xito
            try {
                const s = document.getElementById('tiktok-success');
                if (s) { s.classList.remove('hidden'); s.style.display = 'block'; }
                const f = document.getElementById('contact-form');
                if (f) f.style.display = 'none';
            } catch (_) {}
        }
    }

    // --- Modal de fallback din√°mico ---
    function showFallbackModal(message: string, urls: ReturnType<typeof buildWhatsAppURLs>) {
        if (document.getElementById('wa-fallback-overlay')) return;

        const overlay = document.createElement('div');
        overlay.id = 'wa-fallback-overlay';
        overlay.className = 'fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60';
        overlay.innerHTML = `
            <div style="background:white;border-radius:16px;padding:24px;max-width:380px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                <button id="wa-fb-close" style="position:absolute;top:12px;right:12px;background:none;border:none;font-size:24px;cursor:pointer;color:#999;">‚úï</button>
                <div style="font-size:48px;margin-bottom:12px;">üì±</div>
                <h3 style="font-size:18px;font-weight:700;margin-bottom:6px;">¬øNo se abri√≥ WhatsApp?</h3>
                <p style="font-size:13px;color:#666;margin-bottom:20px;">Usa una de estas opciones:</p>
                <a href="${urls.native}" style="display:block;width:100%;padding:14px;background:#25D366;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:8px;text-decoration:none;box-sizing:border-box;text-align:center;">
                    üì≤ Abrir WhatsApp
                </a>
                <a href="${urls.api}" target="_blank" rel="noopener noreferrer" style="display:block;width:100%;padding:14px;background:#128C7E;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:8px;text-decoration:none;box-sizing:border-box;text-align:center;">
                    üåê Enlace alternativo
                </a>
                <button id="wa-fb-copy" style="width:100%;padding:14px;background:#111;color:white;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:8px;">
                    üìã Copiar mensaje
                </button>
                <p id="wa-fb-success" style="display:none;font-size:12px;color:#059669;font-weight:600;margin-top:8px;">‚úÖ ¬°Copiado! Env√≠alo al +52 55 9165 9829</p>
                <button id="wa-fb-close2" style="width:100%;padding:12px;background:transparent;color:#666;border:1px solid #ddd;border-radius:12px;font-size:14px;cursor:pointer;">Cerrar</button>
            </div>
        `;
        document.body.appendChild(overlay);

        document.getElementById('wa-fb-close')?.addEventListener('click', () => overlay.remove());
        document.getElementById('wa-fb-close2')?.addEventListener('click', () => overlay.remove());
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });

        document.getElementById('wa-fb-copy')?.addEventListener('click', () => {
            copyToClipboard(message).then(() => {
                const btn = document.getElementById('wa-fb-copy');
                if (btn) { btn.textContent = '‚úÖ ¬°Copiado!'; btn.style.background = '#059669'; }
                const s = document.getElementById('wa-fb-success');
                if (s) s.style.display = 'block';
            });
        });
    }

    // === INIT ===

    // Mostrar banner si estamos en in-app browser
    if (isInAppBrowser()) {
        const banner = document.getElementById('inapp-banner');
        if (banner) banner.classList.remove('hidden');

        // En TikTok: mostrar campo celular, cambiar bot√≥n, y personalizar banner
        if (isTikTok()) {
            const bannerText = banner?.querySelector('p:first-child');
            if (bannerText) bannerText.textContent = '‚ö†Ô∏è Est√°s navegando desde TikTok';
            const bannerDesc = banner?.querySelector('p:nth-child(2)');
            if (bannerDesc) bannerDesc.textContent = 'Para que WhatsApp abra correctamente, abre esta p√°gina en Safari o Chrome.';

            // Mostrar campo celular y hacerlo obligatorio
            const celularField = document.getElementById('celular-field');
            const celularInput = document.getElementById('celular') as HTMLInputElement;
            if (celularField) celularField.classList.remove('hidden');
            if (celularInput) celularInput.required = true;

            // Cambiar texto del bot√≥n submit
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) submitBtn.textContent = 'Enviar formulario';
        }
        
        document.getElementById('copy-url-btn')?.addEventListener('click', () => {
            copyToClipboard(window.location.href).then(() => {
                const btn = document.getElementById('copy-url-btn');
                if (btn) {
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> ¬°Enlace copiado!';
                    setTimeout(() => {
                        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copiar enlace de esta p√°gina';
                    }, 3000);
                }
            });
        });
    }

    // Preseleccionar opci√≥n basada en par√°metro URL
    const urlParams = new URLSearchParams(window.location.search);
    const solucionParam = urlParams.get('solucion');
    if (solucionParam === 'ia') {
        const r = document.querySelector('input[name="solucion"][value="Soluciones con IA"]') as HTMLInputElement;
        if (r) r.checked = true;
    } else if (solucionParam === 'ventas') {
        const r = document.querySelector('input[name="solucion"][value="Soluciones de venta"]') as HTMLInputElement;
        if (r) r.checked = true;
    }

    // --- Variables globales ---
    let lastMessage = '';

    // --- Modal HTML existente controls ---
    document.getElementById('close-modal')?.addEventListener('click', () => {
        document.getElementById('fallback-modal')?.classList.add('hidden');
    });
    document.getElementById('fallback-modal')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) document.getElementById('fallback-modal')?.classList.add('hidden');
    });
    document.getElementById('copy-msg-btn')?.addEventListener('click', () => {
        copyToClipboard(lastMessage).then(() => {
            const s = document.getElementById('copy-success');
            if (s) s.classList.remove('hidden');
            setTimeout(() => { window.location.href = 'whatsapp://'; }, 600);
            setTimeout(() => { if (s) s.classList.add('hidden'); }, 5000);
        });
    });

    // --- GOOGLE SHEETS ---
    const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbxuTeZTTYkiiaC9XmD5CvI4b-qh5KX-JVUh-ZtFqf6JJt2f2GhKdqPvzK1Db8qXw1-Qxw/exec';

    function sendToGoogleSheets(data: Record<string, string>): Promise<boolean> {
        // Estrategia multi-fallback para m√°xima compatibilidad con in-app browsers (TikTok, IG, etc.)
        // 1. Intento principal: form POST via iframe oculto (bypasea CORS, funciona en todos los WebViews)
        // 2. Fallback: fetch con text/plain (header "simple" permitido en no-cors)
        // 3. Fallback final: sendBeacon

        return new Promise((resolve) => {
            let resolved = false;
            function done(success: boolean) {
                if (resolved) return;
                resolved = true;
                resolve(success);
            }

            // === M√âTODO 1: Form POST via iframe oculto (m√°s confiable en WebViews) ===
            try {
                const iframe = document.createElement('iframe');
                iframe.name = 'sheets-iframe-' + Date.now();
                iframe.style.cssText = 'display:none;width:0;height:0;border:0;position:absolute;left:-9999px;';
                iframe.setAttribute('sandbox', 'allow-scripts allow-forms');
                iframe.setAttribute('tabindex', '-1');
                iframe.setAttribute('aria-hidden', 'true');
                document.body.appendChild(iframe);

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = SHEETS_URL;
                form.target = iframe.name;
                form.style.display = 'none';

                // Enviar datos como campos de formulario
                Object.entries(data).forEach(([key, value]) => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = value || '';
                    form.appendChild(input);
                });

                document.body.appendChild(form);
                form.submit();

                // Limpiar despu√©s de un tiempo
                setTimeout(() => {
                    form.remove();
                    iframe.remove();
                }, 5000);

                // Considerar √©xito despu√©s de submit (no podemos verificar cross-origin)
                setTimeout(() => done(true), 500);
            } catch (err) {
                // Si falla el iframe, intentar fetch
                console.warn('iframe form POST failed, trying fetch fallback', err);
            }

            // === M√âTODO 2: fetch con text/plain (header simple, permitido en no-cors) ===
            try {
                fetch(SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(data),
                }).then(() => done(true)).catch(() => {});
            } catch (err) {
                console.warn('fetch fallback failed', err);
            }

            // === M√âTODO 3: sendBeacon como √∫ltimo recurso ===
            try {
                if (navigator.sendBeacon) {
                    const blob = new Blob([JSON.stringify(data)], { type: 'text/plain' });
                    navigator.sendBeacon(SHEETS_URL, blob);
                }
            } catch (err) {
                console.warn('sendBeacon fallback failed', err);
            }

            // Timeout de seguridad
            setTimeout(() => done(true), 3000);
        });
    }

    // --- FORM SUBMISSION ---
    document.getElementById('contact-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        
        const nombre = (formData.get('nombre') as string) || '';
        const empresa = (formData.get('empresa') as string) || '';
        const correo = (formData.get('correo') as string) || '';
        const celular = (formData.get('celular') as string) || '';
        const solucion = (formData.get('solucion') as string) || '';
        const mas = (formData.get('mas') as string) || '';

        // Deshabilitar bot√≥n y mostrar loading
        const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
            submitBtn.classList.add('opacity-70', 'cursor-not-allowed');
        }
        
        // Guardar en Google Sheets (SIEMPRE, para todos los navegadores)
        sendToGoogleSheets({ nombre, empresa, correo, celular, solucion, mensaje: mas });

        let mensaje = `*Nuevo contacto desde Inner Circle*\n\n`;
        mensaje += `*Nombre:* ${nombre}\n`;
        if (empresa) mensaje += `*Empresa:* ${empresa}\n`;
        mensaje += `*Correo:* ${correo}\n`;
        if (celular) mensaje += `*Celular:* ${celular}\n`;
        mensaje += `*Soluci√≥n de inter√©s:* ${solucion}\n`;
        if (mas) mensaje += `\n*Informaci√≥n adicional:*\n${mas}`;
        
        lastMessage = mensaje;
        const urls = buildWhatsAppURLs(mensaje);

        // Actualizar link directo del modal HTML existente
        const directLink = document.getElementById('whatsapp-direct-link') as HTMLAnchorElement;
        if (directLink) directLink.href = urls.api;

        if (isTikTok()) {
            // === TIKTOK: Mostrar √©xito INMEDIATAMENTE y enviar datos en background ===
            // No usar setTimeout para el mensaje ‚Äî es fr√°gil en WebViews de TikTok.
            // Primero mostramos el √©xito, luego enviamos los datos (ya tenemos todo lo que necesitamos).
            showTikTokSuccess();
        } else if (isInAppBrowser()) {
            // === INSTAGRAM/FACEBOOK/OTROS: auto-redirect con cadena de fallback ===
            openWhatsAppInApp(mensaje, urls);
        } else {
            // === NAVEGADOR NORMAL: funciona directo ===
            window.location.href = urls.api;
        }
    });
</script>
